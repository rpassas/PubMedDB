---
title: "PubmedDB"
output: html_notebook
---

##PubMedDB

---
title: "Practicum 2"
output: html_notebook
---

```{r}
# 1. Library
library(RMySQL)
library(XML)
library(DBI)
library(knitr)
```

```{r}
# 2. Settings (Jordan's db)
db_user <- 'cs5200practicum2'
db_password <- 'tctvuje8'
db_name <- 'dbpracticum2'
db_host <- 'practicum2.cb9tzbdsyfxk.us-east-2.rds.amazonaws.com'
db_port <- 3306

# 3. Read data from db
mydb <-  dbConnect(MySQL(), user = db_user, password = db_password,
                 dbname = db_name, host = db_host, port = db_port)
```


```{r}
# 2. Settings (Bob's db)
db_user2 <- 'CS5200'
db_password2 <- 'db2password'
db_name2 <- 'dbpracticum2'
db_host2 <- 'cs5200-practicum2.chwzgwg0nlr5.us-east-1.rds.amazonaws.com'
db_port2 <- 3306

# 3. Read data from db
mydb <-  dbConnect(MySQL(), user = db_user2, password = db_password2,
                 dbname = db_name2, host = db_host2, port = db_port2)
```


```{r}
library(XML)
library(DBI)
library(knitr)
```

```{r jordans path}
path <- "C:/Users/jorda/Documents/CS_Masters/CS5200_Databases/Homework/Practicum2/"
fn <- "pubmed_sample.xml"
fpn = paste0(path, fn)
```

```{r bobs path}
path <-"/Users/robert/Documents/CS5200/Practicum2/"
fn <- "pubmed_sample.xml"
fpn = paste0(path, fn)
```

```{r}
# Reading the XML file and parse into DOM
xmlDOM <- xmlParse(file = fpn)

# get the root node of the DOM tree
r <- xmlRoot(xmlDOM)
```

```{sql createTableAuthor, connection=mydb}
CREATE TABLE IF NOT EXISTS Author (
  author_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL
);
```

```{r}
Author.df <- data.frame (author_id = integer(),
                          first_name = character(),
                          last_name = character(),
                          stringsAsFactors = F)
```

```{sql createTableHistory, connection=mydb}
CREATE TABLE IF NOT EXISTS History (
  history_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  article_id INT NOT NULL,
  pub_status TEXT NOT NULL,
  year INT,
  month INT,
  day INT
);
```

```{r}
History.df <- data.frame (history_id = integer(),
                          article_id = integer(),
                          pub_status = character(),
                          year = integer(),
                          month = integer(),
                          day = integer(),
                          stringsAsFactors = F)
```

```{sql createTableJournal, connection=mydb}
CREATE TABLE IF NOT EXISTS Journal (
  journal_title TEXT PRIMARY KEY
);
```

```{r}
Journal.df <- data.frame (journal_title = character(),
                          stringsAsFactors = F)
```

```{sql createTableIssue, connection=mydb}
CREATE TABLE IF NOT EXISTS JournalIssue (
  issue_id INT PRIMARY KEY,
  journal_title TEXT NOT NULL,
  cited_medium TEXT NOT NULL,
  volume INT NOT NULL,
  issue INT NOT NULL,
  pub_date DATE NOT NULL,
  FOREIGN KEY (journal_title) REFERENCES Journal(journal_title)
  ON DELETE CASCADE,
);
```

```{r}
Issue.df <- data.frame (issue_id = integer(),
                        journal_title = character(),
                          cited_medium = character(),
                          volume = integer(),
                          issue = integer(),
                          pub_date_year = integer(),
                          pub_date_month = character(),
                          stringsAsFactors = F)
```


```{sql createTableArticle, connection=mydb}
CREATE TABLE IF NOT EXISTS Article (
  article_id INT NOT NULL AUTO_INCREMENT PRIMARY KEY,
  journal_id INT NOT NULL,
  article_title TEXT NOT NULL
);
```

```{r}
numArticles <- xmlSize(r) 

Article.df <- data.frame (article_id = integer(),
                          journal_text = character(),
                          article_title = character(),
                          stringsAsFactors = F)
```

```{sql createTableAuthorJoin, connection=mydb}
CREATE TABLE IF NOT EXISTS AuthorJoin (
  author_id INT NOT NULL,
  article_id INT NOT NULL,
  FOREIGN KEY (author_id) REFERENCES Author(author_id)
  ON DELETE CASCADE,
  FOREIGN KEY (article_id) REFERENCES Article(article_id)
  ON DELETE CASCADE,
  PRIMARY KEY (author_id, article_id)
);
```

```{r}
AuthorJoin.df <- data.frame (author_id = integer(),
                          article_id = integer(),
                          stringsAsFactors = F)
```

```{r ParseAuthors}
parseAuthors <- function (anAuthorListNode)
{
  newAuthor.df <- data.frame (author_id = integer(),
                          first_name = character(),
                          last_name = character(),
                          stringsAsFactors = F)
  n <- xmlSize(anAuthorListNode)
  
  for (m in 1:n)
  {
    anAuthor <- anAuthorListNode[[m]]
    first_name <- xmlValue(anAuthor[[2]])
    last_name <- xmlValue(anAuthor[[1]])

    newAuthor.df[m,2] <- first_name
    newAuthor.df[m,3] <- last_name

  }

  return(newAuthor.df)
}
```


```{r ParseJournals}
parseJournals <- function (anArticle)
{
  newJournal.df <- Journal.df <- data.frame (journal_id = integer(),
                          cited_medium = character(),
                          volume = integer(),
                          issue = integer(),
                          pub_date_year = integer(),
                          pub_date_month = character(),
                          journal_title = character(),
                          stringsAsFactors = F)

  #Getting Cited Medium
  CMexp <-"string(./MedlineCitation/Article/Journal/JournalIssue/@CitedMedium)"
  tempCM <- xpathSApply(anArticle,CMexp)
  cited_medium <- tempCM

  #Getting Volume
  volexp <-"./MedlineCitation/Article/Journal/JournalIssue/Volume"
  tempVolume <- xpathSApply(anArticle,volexp)
  volume <- xmlValue(tempVolume)
  
  #Getting Issue
  issueexp <-"./MedlineCitation/Article/Journal/JournalIssue/Issue"
  tempIssue <- xpathSApply(anArticle,issueexp)
  issue <- xmlValue(tempIssue)
  
  #Getting PubDate information
  pubdateexp <- "./MedlineCitation/Article/Journal/JournalIssue/PubDate"
  tempPubDate <- xpathSApply(anArticle,pubdateexp)
  singlenode <- tempPubDate[[1]]
  childnodes <- xmlChildren(singlenode)
  
  year <- xmlValue(childnodes[1])
  month <- xmlValue(childnodes[2])

  #Getting Title
  titleeexp <-"./MedlineCitation/Article/Journal/Title"
  tempTitle <- xpathSApply(anArticle,titleeexp)
  title <- xmlValue(tempTitle)

  newJournal.df[1,2] <- cited_medium
  newJournal.df[1,3] <- volume
  newJournal.df[1,4] <- issue
  newJournal.df[1,5] <- year
  newJournal.df[1,6] <- month
  newJournal.df[1,7] <- title
  
  return(newJournal.df)
}
```

```{r Parse JournalIssue}
parseIssues <- function (anArticle)
{
  newIssue.df <- Journal.df <- data.frame (journal_id = integer(),
                          cited_medium = character(),
                          volume = integer(),
                          issue = integer(),
                          pub_date_year = integer(),
                          pub_date_month = character(),
                          journal_title = character(),
                          stringsAsFactors = F)

  #Getting Cited Medium
  CMexp <-"string(./MedlineCitation/Article/Journal/JournalIssue/@CitedMedium)"
  tempCM <- xpathSApply(anArticle,CMexp)
  cited_medium <- tempCM

  #Getting Volume
  volexp <-"./MedlineCitation/Article/Journal/JournalIssue/Volume"
  tempVolume <- xpathSApply(anArticle,volexp)
  volume <- xmlValue(tempVolume)
  
  #Getting Issue
  issueexp <-"./MedlineCitation/Article/Journal/JournalIssue/Issue"
  tempIssue <- xpathSApply(anArticle,issueexp)
  issue <- xmlValue(tempIssue)
  
  #Getting PubDate information
  pubdateexp <- "./MedlineCitation/Article/Journal/JournalIssue/PubDate"
  tempPubDate <- xpathSApply(anArticle,pubdateexp)
  singlenode <- tempPubDate[[1]]
  childnodes <- xmlChildren(singlenode)
  
  year <- xmlValue(childnodes[1])
  month <- xmlValue(childnodes[2])

  #Getting Title
  titleeexp <-"./MedlineCitation/Article/Journal/Title"
  tempTitle <- xpathSApply(anArticle,titleeexp)
  title <- xmlValue(tempTitle)

  newJournal.df[1,2] <- cited_medium
  newJournal.df[1,3] <- volume
  newJournal.df[1,4] <- issue
  newJournal.df[1,5] <- year
  newJournal.df[1,6] <- month
  newJournal.df[1,7] <- title
  
  return(newJournal.df)
}

```



```{r ParseHistory}
parseHistory <- function (aHistoryNode)
{
  newHistory.df <- History.df <- data.frame (history_id = integer(),
                          article_id = integer(),
                          pub_status = character(),
                          year = integer(),
                          month = integer(),
                          day = integer(),
                          stringsAsFactors = F)
  n <- xmlSize(aHistoryNode)
  
  for (m in 1:n)
  {
    
    aDateNode <- aHistoryNode[[m]]
    
    dateNodeAttributes <- xmlAttrs(aDateNode)
    pub_status <- as.character(dateNodeAttributes[1])

    hisYear <- xmlValue(aDateNode[[1]])
    hisMonth <- xmlValue(aDateNode[[2]])
    hisDay <- xmlValue(aDateNode[[3]])
    
    newHistory.df[m,3] <- pub_status
    newHistory.df[m,4] <- hisYear
    newHistory.df[m,5] <- hisMonth
    newHistory.df[m,6] <- hisDay

  }

  return(newHistory.df)
}
```

```{r Q1}
xpathexpression <-"//PubmedArticle/MedlineCitation/Article/ArticleTitle"
xpathexpression2 <-"//MedlineCitation/Article/AuthorList/Author"
x <- xpathSApply(xmlDOM,xpathexpression)

print(x)
```

```{r}
#Iterate through the number of articles
for (i in 1:numArticles) #should be numArticles not 3
{
  #Get the next article node
  anArticle <- r[[i]]
  
  #Parse Author information, returns a data frame of the authors of an individual article
  authorNode <-"./MedlineCitation/Article/AuthorList/Author"
  xauth <- xpathSApply(anArticle,authorNode)
  newAuthor.df <- parseAuthors(xauth)
  
  #Adding the Authors to the Author.df
  tempAuthors <- Author.df
  Author.df <- rbind(tempAuthors, newAuthor.df)
  
  #Parse the journal node
  newJournal.df <- parseJournals(anArticle)
  
  #Adding the journals to the journal.df
  tempJournal <-Journal.df
  Journal.df <- rbind(tempJournal,newJournal.df)
  
  #Parse History information, returns a data frame of the history dates of an individual article
  historyNode <-"./PubmedData/History/PubMedPubDate"
  xhistory <- xpathSApply(anArticle,historyNode)
  newHistory.df <- parseHistory(xhistory)
  
  #Adding the journals to the journal.df
  tempHistory <-History.df
  History.df <- rbind(tempHistory,newHistory.df)
  
  #Getting article title Node
  titleNode <-"./MedlineCitation/Article/ArticleTitle"
  xtitle <- xpathSApply(anArticle,titleNode)
  artTitle <- as.character(xmlValue(xtitle[1]))
  
  #Adding article title and article_id to data frame
  Article.df[i,3] <- artTitle
  Article.df[i,1] <- i
}
#Delete History Duplicates
duplicateJournals <- Journal.df
Journal.df <- duplicateJournals[!duplicated(duplicateJournals),]

#Delete Author Duplicates
duplicateAuthors <- Author.df
Author.df <- duplicateAuthors[!duplicated(duplicateAuthors),]

#Delete History Duplicates
duplicateHistory <- History.df
History.df <- duplicateHistory[!duplicated(duplicateHistory),]

print(History.df)
print(Author.df)
print(Journal.df)
print(Article.df)
```

```{r Adding author_id}
num.authors <- nrow(Author.df)

for (r in 1:num.authors){
  Author.df$author_id[r] <- r
}

print(Author.df)
```

```{r Adding journal_id}
num.journals <- nrow(Journal.df)

for (r in 1:num.journals){
  Journal.df$journal_id[r] <- r
}
print(Journal.df)
```



```{r Adding history_id}
num.history <- nrow(History.df)

for (r in 1:num.history){
  History.df$history_id[r] <- r
}
print(History.df)
```

```{r Link Journals}
print(num.journals)

for (i in 1:numArticles) {
  anArticle <- r[[i]]
  
  #Getting the journal title to compare to
  titleeexp <-"./MedlineCitation/Article/Journal/Title"
  tempTitle <- xpathSApply(anArticle,titleeexp)
  journaltitle <- xmlValue(tempTitle)

  volexp <-"./MedlineCitation/Article/Journal/JournalIssue/Volume"
  tempVolume <- xpathSApply(anArticle,volexp)
  volume <- xmlValue(tempVolume)
  
  #Getting Issue
  issueexp <-"./MedlineCitation/Article/Journal/JournalIssue/Issue"
  tempIssue <- xpathSApply(anArticle,issueexp)
  issue <- xmlValue(tempIssue)
  
  print(Journal.df$journal_title[j])
  print(journaltitle)
  
  for(j in 1:num.journals){
    if(Journal.df$journal_title[j] == journaltitle && Journal.df$volume[j] == volume && Journal.df$issue == issue){

        a <- j
        Article.df$journal_id[i] <- a
        print(a)
    }
  }
  
}
print(Article.df)
```

```{r Link History}

```
















